generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  name         String?
  role         String    @default("user")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  processes    Process[]
  // TODO: Uncomment after applying migration via Supabase Dashboard
  // createdTasks Task[]    @relation("TasksCreated")

  @@map("users")
}

model Process {
  id           String                 @id @default(uuid())
  userId       String                 @map("user_id")
  title        String
  description  String?
  northStar    String?                @map("north_star")
  currentPhase ProcessPhase           @default(ELIGIBILITY) @map("current_phase")
  progress     Int                    @default(0)
  createdAt    DateTime               @default(now()) @map("created_at")
  updatedAt    DateTime               @updatedAt @map("updated_at")
  criteria     CriteriaEvidence[]
  user         User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  letters      RecommendationLetter[]
  tasks        Task[]

  @@index([userId])
  @@map("processes")
}

model Task {
  id          String       @id @default(uuid())
  processId   String       @map("process_id")
  phase       ProcessPhase
  title       String
  description String?
  status      TaskStatus   @default(PENDING)
  order       Int          @default(0)
  dependsOn   String[]     @map("depends_on")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  completedAt DateTime?    @map("completed_at")
  // TODO: Uncomment after applying migration via Supabase Dashboard
  // createdById String?      @map("created_by_id")
  process     Process      @relation(fields: [processId], references: [id], onDelete: Cascade)
  // createdBy   User?        @relation("TasksCreated", fields: [createdById], references: [id], onDelete: SetNull)
  uploads     Upload[]

  @@index([processId, phase])
  // @@index([createdById])
  @@map("tasks")
}

model Upload {
  id          String   @id @default(uuid())
  taskId      String   @map("task_id")
  fileName    String   @map("file_name")
  fileType    String   @map("file_type")
  fileSize    BigInt   @map("file_size")
  fileUrl     String   @map("file_url")
  storagePath String   @map("storage_path")
  uploadedAt  DateTime @default(now()) @map("uploaded_at")
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@map("uploads")
}

model CriteriaEvidence {
  id               String      @id @default(uuid())
  processId        String      @map("process_id")
  criteria         EB1Criteria
  overview         String?
  context          String?
  impact           String?
  evidence         String?
  metricsData      Json?       @map("metrics_data")
  isValidated      Boolean     @default(false) @map("is_validated")
  validationScore  Int?        @map("validation_score")
  validationIssues Json?       @map("validation_issues")
  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")
  process          Process     @relation(fields: [processId], references: [id], onDelete: Cascade)

  @@index([processId, criteria])
  @@map("criteria_evidences")
}

model RecommendationLetter {
  id               String   @id @default(uuid())
  processId        String   @map("process_id")
  recommenderName  String   @map("recommender_name")
  recommenderTitle String   @map("recommender_title")
  recommenderOrg   String?  @map("recommender_org")
  recommenderEmail String?  @map("recommender_email")
  content          String?
  status           String   @default("draft")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")
  process          Process  @relation(fields: [processId], references: [id], onDelete: Cascade)

  @@index([processId])
  @@map("recommendation_letters")
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  action     String
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  before     Json?
  after      Json?
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@index([entityType, entityId])
  @@map("audit_logs")
}

enum ProcessPhase {
  ELIGIBILITY
  EVIDENCE
  LETTERS
  PETITION
  FILING
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  UNDER_REVIEW
  COMPLETED
  WITH_UPLOAD
  BLOCKED
}

enum EB1Criteria {
  AWARDS
  MEMBERSHIP
  PRESS
  JUDGING
  ORIGINAL
  SCHOLARLY
  CRITICAL
  HIGH_SALARY
  EXHIBITIONS
  COMMERCIAL_SUCCESS
}
